# .github/workflows/release.yml
name: SDK Release

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: "SDK version"
        required: true
        type: string
      backend_version:
        description: "Backend version"
        required: true
        type: string
      codename:
        description: "Codename"
        required: true
        type: string
      test_run:
        description: "Test run (commit & push only; skip tagging)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Validate inputs and prepare environment
        id: prep
        shell: bash
        env:
          FILE: Sources/ElvahCharge/Core/Version.swift
          SDK_VERSION: ${{ inputs.sdk_version }}
          BACKEND_VERSION: ${{ inputs.backend_version }}
          CODENAME: ${{ inputs.codename }}
        run: |
          set -euo pipefail

          if [[ ! -f "$FILE" ]]; then
            echo "::error::Version file not found: $FILE"
            exit 1
          fi

          # SemVer 2.0.0 validation (allows -prerelease and +build)
          semver_re='^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$'
          if [[ ! "$SDK_VERSION" =~ $semver_re ]]; then
            echo "::error::sdk_version must be SemVer (e.g., 1.2.3, 1.2.3-rc.1, 1.2.3+build.5). Given: $SDK_VERSION"
            exit 1
          fi

          echo "file=$FILE"     >> "$GITHUB_OUTPUT"
          echo "sdk=$SDK_VERSION" >> "$GITHUB_OUTPUT"
          echo "backend=$BACKEND_VERSION" >> "$GITHUB_OUTPUT"
          echo "codename=$CODENAME" >> "$GITHUB_OUTPUT"

          echo "Inputs:"
          echo "  sdk_version     = $SDK_VERSION"
          echo "  backend_version = $BACKEND_VERSION"
          echo "  codename        = $CODENAME"
          echo "  test_run        = ${{ inputs.test_run }}"

      - name: Update Sources/MyLibrary/Version.swift
        shell: bash
        env:
          FILE: ${{ steps.prep.outputs.file }}
          SDK_VERSION: ${{ steps.prep.outputs.sdk }}
          BACKEND_VERSION: ${{ steps.prep.outputs.backend }}
          CODENAME: ${{ steps.prep.outputs.codename }}
        run: |
          set -euo pipefail
          esc() { printf '%s' "$1" | sed -e 's/[\/&]/\\&/g'; }
          SDK_E="$(esc "$SDK_VERSION")"
          BE_E="$(esc "$BACKEND_VERSION")"
          CODE_E="$(esc "$CODENAME")"

          sed -i.bak -E "s/(static let sdk: String = )\"[^\"]*\"/\1\"$SDK_E\"/" "$FILE"
          sed -i.bak -E "s/(static let backend: String = )\"[^\"]*\"/\1\"$BE_E\"/" "$FILE"
          sed -i.bak -E "s/(static let codename: String = )\"[^\"]*\"/\1\"$CODE_E\"/" "$FILE"
          rm -f "$FILE.bak"

          echo "Updated constants:"
          grep -En 'static let (sdk|backend|codename)' "$FILE" || true

      - name: Commit version bump
        shell: bash
        env:
          SDK_VERSION: ${{ steps.prep.outputs.sdk }}
          FILE: ${{ steps.prep.outputs.file }}
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --quiet -- "$FILE"; then
            echo "No changes detected in $FILE; nothing to commit."
          else
            git add "$FILE"
            git commit -m "chore(release): ${SDK_VERSION} â€“ update Version.swift"
          fi

          echo "--- Diff ---"
          git --no-pager show --name-only --oneline

      - name: Push commit
        shell: bash
        run: |
          set -euo pipefail
          git pull --ff-only origin "${{ github.ref_name }}"
          git push origin "HEAD:${{ github.ref_name }}"

      - name: "Test run: skipping tag creation"
        if: ${{ inputs.test_run == true || inputs.test_run == 'true' }}
        run: echo "Test run enabled; no tag will be created."

      - name: Create and push tag
        if: ${{ !(inputs.test_run == true || inputs.test_run == 'true') }}
        shell: bash
        env:
          TAG: ${{ steps.prep.outputs.sdk }}
        run: |
          set -euo pipefail
          if git rev-parse "$TAG" >/dev/null 2>&1 || git ls-remote --tags origin "$TAG" | grep -q .; then
            echo "::error::Tag '$TAG' already exists."
            exit 1
          fi
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
